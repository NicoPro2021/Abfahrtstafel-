name: Zerbst Live Update
on:
  workflow_dispatch:
  schedule:
    - cron: '*/45 * * * *'

# Verhindert das Chaos: Nur ein einziger Bot darf zur Zeit laufen
concurrency:
  group: bahn-update
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - run: pip install requests

      - name: 40 Minuten Dauer-Loop
        run: |
          git config --global user.name "Zerbst Bot"
          git config --global user.email "bot@zerbst.de"
          
          # Wir machen 30 Durchl채ufe alle 80 Sekunden (entspannter f체r GitHub)
          for i in {1..30}
          do
            echo "Update Durchlauf $i..."
            python bot.py
            
            # Pr체fen ob Datei existiert und echtes JSON ist
            if grep -q "^\[" daten.json; then
              git add daten.json
              # Nur committen, wenn sich der Inhalt wirklich ge채ndert hat
              git diff --quiet && git diff --staged --quiet || (git commit -m "Live Update $i" && git push)
            fi
            
            echo "Warte 80 Sekunden..."
            sleep 80
          done

      - name: Neustart-Trigger
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Bot-Runde beendet. Starte neue Instanz..."
          sleep 10
          gh workflow run bahn_final.yml
