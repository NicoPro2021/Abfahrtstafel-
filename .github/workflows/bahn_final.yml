name: Zerbst Live Update
on:
  workflow_dispatch:
  schedule:
    - cron: '*/40 * * * *'

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - run: pip install requests

      - name: 40 Minuten Dauer-Loop
        run: |
          git config --global user.name "Zerbst Bot"
          git config --global user.email "bot@zerbst.de"
          
          for i in {1..40}
          do
            echo "Durchlauf $i: Python Bot wird gestartet..."
            python bot.py
            
            # Prüfen, ob bot.py ein gültiges JSON erstellt hat
            if grep -q "^\[" daten.json; then
              git add daten.json
              git commit -m "Live Update $i" || echo "Keine Änderung"
              git push || echo "Warte auf nächsten Lauf"
            else
              echo "Fehler: daten.json ist kein gültiges JSON!"
            fi
            
            echo "Warte 60 Sekunden..."
            sleep 60
          done

      - name: Sofort-Neustart
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh workflow run bahn_final.yml
