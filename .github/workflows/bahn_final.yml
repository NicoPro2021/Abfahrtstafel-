name: Endlos High-Frequency Update

on:
  workflow_dispatch:      # Ermöglicht den manuellen Erststart
  schedule:
    - cron: '0 * * * *'   # Sicherheits-Start jede Stunde, falls der Loop mal reißt

# Schutz: Verhindert, dass zwei Workflows gleichzeitig laufen und sich blockieren
concurrency: 
  group: bahn-update-group
  cancel-in-progress: false 

jobs:
  update-cycle:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
      - name: Code auschecken
        uses: actions/checkout@v3

      - name: Python installieren
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Bibliotheken installieren
        run: pip install requests

      - name: 40 Minuten Update-Schleife (alle 80s)
        run: |
          # 30 Durchläufe mal 80 Sekunden ergeben 2400 Sekunden (40 Minuten)
          for i in {1..30}
          do
            echo "--- Durchlauf $i von 30 - Starte alle 10 Bots ---"
            
            # Führt alle 10 Bots nacheinander aus
            python zerbst_bot.py
            python rodleben_bot.py
            python rosslau_bot.py
            python dessau_hbf_bot.py
            python dessau_sued_bot.py
            python biederitz_bot.py
            python magdeburg_hbf_bot.py
            python magdeburg_neustadt_bot.py
            python magdeburg_herrenkrug_bot.py
            python leipzig_hbf_bot.py
            
            # Änderungen speichern und pushen
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action Bot"
            git add *.json
            
            # Nur committen, wenn sich wirklich Daten geändert haben (spart Speicher)
            git diff --quiet && git diff --staged --quiet || (git commit -m "Live-Update Durchlauf $i" && git push)
            
            echo "Warte 80 Sekunden bis zum nächsten Abruf..."
            sleep 80
          done

      - name: Workflow neu starten (Endlos-Schleife)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "40 Minuten Zyklus beendet. Starte neuen Workflow..."
          # Kurze Abkühlphase vor dem Neustart
          sleep 20
          gh workflow run "Endlos High-Frequency Update"
